import{i as he,h as Ne,o as G,p as _e,q as Ie,t as we,v as Me}from"./medical-c6f0a0f6.js";import{d as Ve,a as u,r as Ce,q as Se,K as De,b as g,o as D,k as U,e as M,f as o,w as s,E as i,A as z,g as v,y as F,c as Fe,l as Te,F as He,p as xe,i as Re,_ as Pe}from"./index-01cbf18e.js";const J=V=>(xe("data-v-ad9b9f8a"),V=V(),Re(),V),$e={class:"medical-records"},ke=J(()=>M("h2",{class:"page-title"},"病历管理",-1)),Ae={class:"search-section"},Be=J(()=>M("i",{class:"el-icon-delete"},null,-1)),Ue={class:"pagination"},ze={key:0},Le={class:"dialog-footer"},Ee=Ve({__name:"MedicalRecords",setup(V){const C=u(""),y=u(!1),N=u(""),f=u(!1),T=u(1),H=u(10),Q=u(0),L=u([]),S=u(!1),I=u([]),x=u(!1),a=Ce({recordId:0,patientName:"",doctorName:"",hospitalName:"",department:"",registrationInfo:"",pastMedicalHistory:"",currentMedicalHistory:"",isFilled:!1,createdAt:0}),R=u(),P=parseInt(localStorage.getItem("userId")||"0"),E=u("");let m=null;const $=()=>{E.value=k(Date.now())},p=u([]),W=()=>{console.log("患者输入框获得焦点"),p.value.length===0&&(console.log("尝试加载患者列表..."),O())},O=async()=>{console.log("开始获取患者列表...");const t=[{patientId:1,patientName:"张三"},{patientId:2,patientName:"李四"},{patientId:3,patientName:"王五"}];try{const e=await _e();return console.log("API返回原始患者数据:",e),e&&Array.isArray(e)&&e.length>0?(p.value=e.map(l=>({patientId:l.patientId,patientName:l.patientName})),console.log("获取患者列表成功，数量:",p.value.length),Promise.resolve(e)):(console.warn("API未返回有效患者数据，使用测试数据"),p.value=t,Promise.resolve(t))}catch(e){return console.error("获取患者列表失败",e),console.warn("使用测试数据代替"),p.value=t,Promise.resolve(t)}},X=(t,e)=>{console.log("查询患者，查询字符串:",t,"当前列表长度:",p.value.length),!p.value||p.value.length===0?(console.log("患者列表为空，尝试加载..."),O().then(()=>{console.log("加载后过滤患者"),q(t,e)})):(console.log("使用现有患者列表过滤"),q(t,e))},q=(t,e)=>{if(console.log("过滤患者，输入字符:",t),!p.value||p.value.length===0){const r=[{patientId:1,patientName:"张三"},{patientId:2,patientName:"李四"},{patientId:3,patientName:"王五"}].map(c=>({value:c.patientName,id:String(c.patientId),label:`${c.patientName}`}));console.log("没有患者数据，使用测试数据"),e(r);return}if(!t){const r=p.value.map(c=>({value:c.patientName,id:String(c.patientId||0),label:`${c.patientName}`}));console.log("返回所有患者:",r.length),e(r);return}const l=p.value.filter(r=>!r||!r.patientName?!1:r.patientName.toLowerCase().includes(t.toLowerCase()));console.log("过滤后的结果数量:",l.length);const d=l.map(r=>({value:r.patientName,id:String(r.patientId||0),label:`${r.patientName}`}));console.log("返回的患者建议列表数量:",d.length),e(d)},Z=t=>{a.patientName=t.value,console.log("已选择患者:",t)},j=[{value:"内科",label:"内科"},{value:"外科",label:"外科"},{value:"妇产科",label:"妇产科"},{value:"儿科",label:"儿科"},{value:"眼科",label:"眼科"},{value:"口腔科",label:"口腔科"},{value:"耳鼻喉科",label:"耳鼻喉科"},{value:"皮肤科",label:"皮肤科"},{value:"神经科",label:"神经科"},{value:"精神心理科",label:"精神心理科"},{value:"肿瘤科",label:"肿瘤科"},{value:"中医科",label:"中医科"},{value:"急诊科",label:"急诊科"},{value:"检验科",label:"检验科"},{value:"放射科",label:"放射科"},{value:"麻醉科",label:"麻醉科"},{value:"整形科",label:"整形科"},{value:"营养科",label:"营养科"},{value:"康复科",label:"康复科"}],ee=(t,e)=>{const l=t?j.filter(d=>d.value.toLowerCase().includes(t.toLowerCase())):j;e(l)},te=t=>{a.department=t.value},K=[{value:"北京协和医院",label:"北京协和医院"},{value:"首都医科大学附属北京天坛医院",label:"首都医科大学附属北京天坛医院"},{value:"北京大学第一医院",label:"北京大学第一医院"},{value:"北京大学人民医院",label:"北京大学人民医院"},{value:"北京大学第三医院",label:"北京大学第三医院"},{value:"中国医学科学院北京协和医院",label:"中国医学科学院北京协和医院"},{value:"中国医学科学院肿瘤医院",label:"中国医学科学院肿瘤医院"},{value:"首都医科大学附属北京友谊医院",label:"首都医科大学附属北京友谊医院"},{value:"首都医科大学宣武医院",label:"首都医科大学宣武医院"},{value:"北京中医药大学东直门医院",label:"北京中医药大学东直门医院"},{value:"复旦大学附属中山医院",label:"复旦大学附属中山医院"},{value:"复旦大学附属华山医院",label:"复旦大学附属华山医院"},{value:"上海交通大学医学院附属瑞金医院",label:"上海交通大学医学院附属瑞金医院"},{value:"上海交通大学医学院附属仁济医院",label:"上海交通大学医学院附属仁济医院"},{value:"中山大学附属第一医院",label:"中山大学附属第一医院"}],ae=(t,e)=>{const l=t?K.filter(d=>d.value.toLowerCase().includes(t.toLowerCase())):K;e(l)},le=t=>{a.hospitalName=t.value},oe=async()=>{if(C.value==""){i.error("请输入病历ID");return}try{const t=parseInt(C.value);if(isNaN(t)){i.error("病历ID必须是数字");return}S.value=!0,console.log(`尝试搜索病历，ID: ${t}, 用户ID: ${P}`);let e=await he(t,P);console.log("病历查询结果:",e),e.code===200?(console.log("病历查询结果:",e),_(),a.recordId=e.recordId,a.patientName=e.patientName||"",a.doctorName=e.doctorName||"",a.hospitalName=e.hospitalName||"",a.department=e.department||"",a.registrationInfo=e.registrationInfo||"",a.pastMedicalHistory=e.pastMedicalHistory||"",a.currentMedicalHistory=e.currentMedicalHistory||"",a.isFilled=e.isFilled||!1,a.createdAt=e.createTime||Date.now(),f.value=e.isFilled,N.value="病历详情",y.value=!0,i.success("查询病历成功")):i.error("搜索失败，未找到病历信息")}catch(t){console.error("搜索病历出错:",t),i.error("搜索失败")}finally{S.value=!1}},ne=t=>{H.value=t,h()},re=t=>{T.value=t,h()},se=t=>{z.confirm("确认完成此病历?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=parseInt(t.recordId),l=await Ie(e);console.log("完成病历响应:",l),l&&l.code===200?(i.success("病历已完成"),h()):i.error((l==null?void 0:l.msg)||"操作失败")}catch{i.error("操作失败")}})},ie=()=>{_(),N.value="填写病历",f.value=!1,y.value=!0,$(),m&&clearInterval(m),m=setInterval($,1e3)},de={patientName:[{required:!0,message:"请输入患者姓名",trigger:"blur"}],doctorName:[{required:!0,message:"请输入医生姓名",trigger:"blur"}],hospitalName:[{required:!0,message:"请输入医院名称",trigger:"blur"}],department:[{required:!0,message:"请输入科室",trigger:"blur"}]},ce=async()=>{if(R.value)try{await R.value.validate(async t=>{if(t){typeof a.patientName!="string"&&(a.patientName=String(a.patientName)),typeof a.doctorName!="string"&&(a.doctorName=String(a.doctorName));const e=Date.now();if(N.value==="填写病历"){a.createdAt=e;const l=await we(a.patientName,a.doctorName,a.hospitalName,a.department,a.registrationInfo,a.pastMedicalHistory,a.currentMedicalHistory,e);console.log("创建病历响应:",l),l&&l.code===200?(i.success("病历填写成功"),y.value=!1,h(),_()):i.error("病历填写失败")}else{a.createdAt=e;const l=await Me(a.recordId,a.hospitalName,a.department,a.registrationInfo,a.pastMedicalHistory,a.currentMedicalHistory,e);console.log("更新病历响应:",l),l&&l.code===200?(i.success("病历详情保存成功"),y.value=!1,h(),_()):i.error("病历详情保存失败")}m&&(clearInterval(m),m=null)}else i.warning("请填写完整病历信息并确保格式正确")})}catch{i.error("填写病历失败")}},ue=t=>{Object.assign(a,{recordId:t.recordId,patientName:typeof t.patientName=="number"?String(t.patientName):t.patientName,doctorName:typeof t.doctorName=="number"?String(t.doctorName):t.doctorName,hospitalName:t.hospitalName,department:t.department,registrationInfo:t.registrationInfo,pastMedicalHistory:t.pastMedicalHistory,currentMedicalHistory:t.currentMedicalHistory,isFilled:t.isFilled,createdAt:t.createTime&&typeof t.createTime=="string"&&!isNaN(Date.parse(t.createTime))?Date.parse(t.createTime):t.createdAt||Date.now()}),f.value=t.isFilled,N.value="病历详情",y.value=!0},pe=async t=>{if(!t.isFilled){i.warning("只能删除已完成的病历");return}z.confirm("确认删除此病历?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=parseInt(t.recordId),l=await G(e);l.code===200?(i.success("删除成功"),h()):i.error((l==null?void 0:l.msg)||"删除失败")}catch{i.error("删除失败")}})},k=t=>{if(!t)return"";const e=new Date(t),l=e.getFullYear(),d=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),w=String(e.getMinutes()).padStart(2,"0"),A=String(e.getSeconds()).padStart(2,"0");return`${l}-${d}-${r} ${c}:${w}:${A}`},h=async()=>{try{S.value=!0;const t=await Ne(P);console.log("获取病历列表响应:",t),L.value=t.map(e=>({...e,createTime:k(e.createTime)}))}catch(t){console.error("获取病历列表失败:",t),i.error("获取病历列表失败")}finally{S.value=!1}},_=()=>{Object.assign(a,{recordId:"",patientName:"",doctorName:localStorage.getItem("name")||"",hospitalName:"",department:"",registrationInfo:"",pastMedicalHistory:"",currentMedicalHistory:"",isFilled:!1,createdAt:0})},me=()=>{m&&(clearInterval(m),m=null),_()},ge=t=>{I.value=t},ve=()=>{if(I.value.length===0){i.warning("请选择要删除的病历");return}const t=I.value.filter(e=>e.isFilled);if(t.length===0){i.warning("只能删除已完成的病历");return}if(x.value){i.warning("正在处理删除请求，请稍候...");return}z.confirm(`确定要删除选中的 ${t.length} 条已完成的病历记录吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{x.value=!0;const e=[];try{for(const l of t){let d=0;const r=3;for(;d<r;)try{await G(l.recordId),await new Promise(c=>setTimeout(c,1e3));break}catch(c){d++,d===r?(console.error(`删除病历 ${l.recordId} 失败，已重试${r}次:`,c),e.push(l.recordId)):await new Promise(w=>setTimeout(w,2e3))}}e.length===0?i.success("批量删除成功"):i.warning(`部分删除成功，${e.length} 条记录删除失败，请稍后重试`),await new Promise(l=>setTimeout(l,1e3)),h(),I.value=[]}catch(l){i.error("批量删除失败，请稍后重试"),console.error("批量删除失败:",l)}finally{x.value=!1}}).catch(()=>{})};return Se(()=>{h(),_(),$()}),De(()=>{m&&clearInterval(m)}),(t,e)=>{const l=g("el-input"),d=g("el-button"),r=g("el-table-column"),c=g("el-tag"),w=g("el-table"),A=g("el-pagination"),b=g("el-descriptions-item"),B=g("el-autocomplete"),fe=g("el-descriptions"),be=g("el-form"),ye=g("el-dialog");return D(),U("div",$e,[ke,M("div",Ae,[o(l,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=n=>C.value=n),placeholder:"请输入病历ID",class:"search-input"},null,8,["modelValue"]),o(d,{type:"primary",onClick:oe,class:"search-button"},{default:s(()=>[v("搜索病历")]),_:1}),o(d,{type:"primary",onClick:ie,class:"add-button"},{default:s(()=>[v("填写病历")]),_:1}),o(d,{type:"danger",onClick:ve,class:"search-button",disabled:!I.value.length},{default:s(()=>[Be,v(" 批量删除 ")]),_:1},8,["disabled"])]),o(w,{data:L.value,border:"",style:{"min-width":"100%"},onSelectionChange:ge},{default:s(()=>[o(r,{type:"selection",width:"55"}),o(r,{fixed:"",prop:"recordId",label:"病历ID",width:"120"}),o(r,{prop:"patientName",label:"患者姓名",width:"120"}),o(r,{prop:"hospitalName",label:"医院名称",width:"180"}),o(r,{prop:"department",label:"科室",width:"120"}),o(r,{prop:"doctorName",label:"医生姓名",width:"120"}),o(r,{prop:"createTime",label:"创建时间",width:"120"}),o(r,{prop:"isFilled",label:"病历状态",width:"100"},{default:s(n=>[o(c,{type:n.row.isFilled?"success":"info"},{default:s(()=>[v(F(n.row.isFilled?"已完成":"未完成"),1)]),_:2},1032,["type"])]),_:1}),o(r,{label:"操作",width:"200"},{default:s(n=>[o(d,{type:"primary",size:"small",onClick:Y=>se(n.row)},{default:s(()=>[v("完成")]),_:2},1032,["onClick"]),o(d,{type:"info",size:"small",onClick:Y=>ue(n.row)},{default:s(()=>[v("编辑")]),_:2},1032,["onClick"]),o(d,{type:"danger",size:"small",onClick:Y=>pe(n.row),disabled:!n.row.isFilled},{default:s(()=>[v("删除")]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"]),M("div",Ue,[o(A,{"current-page":T.value,"onUpdate:currentPage":e[1]||(e[1]=n=>T.value=n),"page-size":H.value,"onUpdate:pageSize":e[2]||(e[2]=n=>H.value=n),"page-sizes":[10,20,30,50],total:Q.value,layout:"total, sizes, prev, pager, next",onSizeChange:ne,onCurrentChange:re},null,8,["current-page","page-size","total"])]),o(ye,{modelValue:y.value,"onUpdate:modelValue":e[12]||(e[12]=n=>y.value=n),title:N.value,width:"60%",onClose:me},{footer:s(()=>[M("span",Le,[o(d,{onClick:e[11]||(e[11]=n=>y.value=!1)},{default:s(()=>[v("取消")]),_:1}),o(d,{type:"primary",onClick:ce},{default:s(()=>[v("保存")]),_:1})])]),default:s(()=>[o(be,{model:a,rules:de,ref_key:"recordFormRef",ref:R},{default:s(()=>[o(fe,{column:2,border:""},{default:s(()=>[N.value!=="填写病历"?(D(),Fe(b,{key:0,label:"病历编号"},{default:s(()=>[o(l,{modelValue:a.recordId,"onUpdate:modelValue":e[3]||(e[3]=n=>a.recordId=n),disabled:!0},null,8,["modelValue"])]),_:1})):Te("",!0),o(b,{label:"患者姓名"},{default:s(()=>[o(B,{modelValue:a.patientName,"onUpdate:modelValue":e[4]||(e[4]=n=>a.patientName=n),"fetch-suggestions":X,placeholder:"请输入患者姓名","trigger-on-focus":!0,clearable:"",disabled:f.value,onSelect:Z,onFocus:W},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"医院名称"},{default:s(()=>[o(B,{modelValue:a.hospitalName,"onUpdate:modelValue":e[5]||(e[5]=n=>a.hospitalName=n),"fetch-suggestions":ae,placeholder:"请输入或选择医院",clearable:"",disabled:f.value,onSelect:le},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"科室"},{default:s(()=>[o(B,{modelValue:a.department,"onUpdate:modelValue":e[6]||(e[6]=n=>a.department=n),"fetch-suggestions":ee,placeholder:"请输入或选择科室",clearable:"",disabled:f.value,onSelect:te},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"医生姓名"},{default:s(()=>[o(l,{modelValue:a.doctorName,"onUpdate:modelValue":e[7]||(e[7]=n=>a.doctorName=n),disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"挂号信息"},{default:s(()=>[o(l,{modelValue:a.registrationInfo,"onUpdate:modelValue":e[8]||(e[8]=n=>a.registrationInfo=n),type:"textarea",rows:2,disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"既往病史"},{default:s(()=>[o(l,{modelValue:a.pastMedicalHistory,"onUpdate:modelValue":e[9]||(e[9]=n=>a.pastMedicalHistory=n),type:"textarea",rows:3,disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"现病史"},{default:s(()=>[o(l,{modelValue:a.currentMedicalHistory,"onUpdate:modelValue":e[10]||(e[10]=n=>a.currentMedicalHistory=n),type:"textarea",rows:3,disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),o(b,{label:"状态"},{default:s(()=>[v(F(a.isFilled?"已完成":"未完成"),1)]),_:1}),o(b,{label:"创建日期"},{default:s(()=>[N.value==="填写病历"?(D(),U("span",ze,F(E.value),1)):(D(),U(He,{key:1},[v(F(k(a.createdAt)),1)],64))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}});const je=Pe(Ee,[["__scopeId","data-v-ad9b9f8a"]]);export{je as default};
