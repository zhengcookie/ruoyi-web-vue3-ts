import{a as Te,b as xe,d as J,c as Ae,e as Se}from"./medical-c6f0a0f6.js";import{d as $e,a as h,r as W,q as ze,b as g,z as Le,o as G,k as K,e as p,f as o,w as a,E as u,A as Q,g as c,y as m,B as Ue,p as Be,i as Pe,_ as Re}from"./index-01cbf18e.js";const T=k=>(Be("data-v-073dee0c"),k=k(),Pe(),k),Me={class:"reserve-info"},qe=T(()=>p("h2",{class:"page-title"},"挂号预约",-1)),Fe={class:"search-section"},He={class:"search-input"},Oe=T(()=>p("i",{class:"el-icon-plus"},null,-1)),Ee=T(()=>p("i",{class:"el-icon-delete"},null,-1)),je={class:"pagination-container"},Ye={class:"appointment-details"},Je={class:"hospital-title"},We=T(()=>p("h3",{class:"record-type"},"挂号预约信息单",-1)),Ge={class:"print-time"},Ke={class:"dialog-footer"},Qe={class:"form-row"},Xe={class:"form-row"},Ze={class:"form-row"},et={class:"dialog-footer"},tt={class:"dialog-footer"},ot=$e({__name:"Reserveinformation",setup(k){const D=h(""),w=h(!1),y=h(!1),b=h(!1),x=h(1),A=h(10),P=h(0),S=h(!1),R=h([]),V=h(),C=h([]),$=h(!1),M=parseInt(localStorage.getItem("userId")||"0"),X=localStorage.getItem("accountAddress")||"",Z=localStorage.getItem("name")||"",n=W({patientName:"",appointmentId:0,hospitalName:"",department:"",doctorName:"",createTime:"",isCompleted:"",remark:""}),i=W({patientName:Z,patient:X,doctorName:"",doctor:"",hospitalName:"",department:"",createTime:"",remark:""}),ee={doctorName:[{required:!0,message:"请输入医生姓名",trigger:"blur"}],hospitalName:[{required:!0,message:"请输入医院名称",trigger:"blur"}],department:[{required:!0,message:"请选择科室",trigger:"blur"}],createTime:[{required:!0,message:"请选择挂号预约时间",trigger:"blur"}],remark:[{required:!0,message:"请输入病情描述",trigger:"blur"}]},_=h([]),q=[{value:"北京协和医院",label:"北京协和医院"},{value:"首都医科大学附属北京天坛医院",label:"首都医科大学附属北京天坛医院"},{value:"北京大学第一医院",label:"北京大学第一医院"},{value:"北京大学人民医院",label:"北京大学人民医院"},{value:"北京大学第三医院",label:"北京大学第三医院"},{value:"中国医学科学院北京协和医院",label:"中国医学科学院北京协和医院"},{value:"中国医学科学院肿瘤医院",label:"中国医学科学院肿瘤医院"},{value:"首都医科大学附属北京友谊医院",label:"首都医科大学附属北京友谊医院"},{value:"首都医科大学宣武医院",label:"首都医科大学宣武医院"},{value:"北京中医药大学东直门医院",label:"北京中医药大学东直门医院"},{value:"复旦大学附属中山医院",label:"复旦大学附属中山医院"},{value:"复旦大学附属华山医院",label:"复旦大学附属华山医院"},{value:"上海交通大学医学院附属瑞金医院",label:"上海交通大学医学院附属瑞金医院"},{value:"上海交通大学医学院附属仁济医院",label:"上海交通大学医学院附属仁济医院"},{value:"中山大学附属第一医院",label:"中山大学附属第一医院"}],te=(t,e)=>{if(console.log("查询医院，输入字符:",t),!t){console.log("返回所有医院"),e(q);return}const l=q.filter(d=>d.value.toLowerCase().includes(t.toLowerCase()));console.log("过滤后的医院数量:",l.length),e(l)},oe=t=>{i.hospitalName=t.value},F=[{value:"内科",label:"内科"},{value:"外科",label:"外科"},{value:"妇产科",label:"妇产科"},{value:"儿科",label:"儿科"},{value:"眼科",label:"眼科"},{value:"口腔科",label:"口腔科"},{value:"耳鼻喉科",label:"耳鼻喉科"},{value:"皮肤科",label:"皮肤科"},{value:"神经科",label:"神经科"},{value:"精神心理科",label:"精神心理科"},{value:"肿瘤科",label:"肿瘤科"},{value:"中医科",label:"中医科"},{value:"急诊科",label:"急诊科"},{value:"检验科",label:"检验科"},{value:"放射科",label:"放射科"},{value:"麻醉科",label:"麻醉科"},{value:"整形科",label:"整形科"},{value:"营养科",label:"营养科"},{value:"康复科",label:"康复科"}],ae=(t,e)=>{if(console.log("查询科室，输入字符:",t),!t){console.log("返回所有科室"),e(F);return}const l=F.filter(d=>d.value.toLowerCase().includes(t.toLowerCase()));console.log("过滤后的科室数量:",l.length),e(l)},le=t=>{i.department=t.value},re=()=>{console.log("医生输入框获得焦点"),_.value.length===0&&(console.log("尝试加载医生列表..."),H())},H=async()=>{console.log("开始获取医生列表...");const t=[{doctorId:1,doctorName:"张医生"},{doctorId:2,doctorName:"李医生"},{doctorId:3,doctorName:"王医生"}];try{const e=await Ae();return console.log("API返回原始数据:",e),e&&Array.isArray(e)&&e.length>0?(_.value=e.map(l=>({doctorId:l.doctorId,doctorName:l.doctorName})),console.log("获取医生列表成功，数量:",_.value.length),Promise.resolve(e)):(console.warn("API未返回有效医生数据，使用测试数据"),_.value=t,Promise.resolve(t))}catch(e){return console.error("获取医生列表失败",e),console.warn("使用测试数据代替"),_.value=t,Promise.resolve(t)}},ne=(t,e)=>{console.log("查询医生，查询字符串:",t,"当前列表长度:",_.value.length),!_.value||_.value.length===0?(console.log("医生列表为空，尝试加载..."),H().then(()=>{console.log("加载后过滤医生"),O(t,e)})):(console.log("使用现有医生列表过滤"),O(t,e))},O=(t,e)=>{if(console.log("过滤医生，输入字符:",t),!_.value||_.value.length===0){const s=[{doctorId:1,doctorName:"张医生"},{doctorId:2,doctorName:"李医生"},{doctorId:3,doctorName:"王医生"}].map(v=>({value:v.doctorName,id:v.doctorId,label:v.doctorName}));console.log("没有医生数据，使用测试数据"),e(s);return}if(!t){const s=_.value.map(v=>({value:v.doctorName,id:v.doctorId||0,label:v.doctorName}));console.log("返回所有医生:",s.length),e(s);return}const l=_.value.filter(s=>!s||!s.doctorName?!1:s.doctorName.toLowerCase().includes(t.toLowerCase()));console.log("过滤后的结果数量:",l.length);const d=l.map(s=>({value:s.doctorName,id:s.doctorId||0,label:s.doctorName}));console.log("返回的医生建议列表:",JSON.stringify(d)),e(d)},se=t=>{i.doctorName=t.value,console.log("已选择医生:",t)},E=t=>t?new Date(t).toLocaleString():"",ie=async()=>{await he()},de=async()=>{if(!D.value){u.warning("请输入预约ID");return}try{const t=parseInt(D.value);if(isNaN(t)){u.error("预约ID必须是数字");return}const e=await Te(t,M);console.log("查询预约响应:",e.code),e?(n.patientName=e.patientName,n.appointmentId=e.appointmentId,n.department=e.department,n.hospitalName=e.hospitalName,n.doctorName=e.doctorName,n.createTime=E(e.createTime),n.isCompleted=e.isCompleted?"已完成":"未完成",n.remark=e.remark,w.value=!0):u.error("查询失败")}catch{u.error("查询失败")}},ce=t=>{A.value=t,N()},ue=t=>{x.value=t,N()},me=t=>{w.value=!0,S.value=!0,Object.assign(n,t),S.value=!1},pe=t=>{Q.confirm("确定要取消该挂号预约吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=await J(t.appointmentId);console.log("取消预约响应:",e),e.code===200?(u.success("取消成功"),N()):u.error("取消失败")}catch{u.error("取消失败")}})},fe=()=>{const t=window.open("","_blank");if(!t){u.error("请允许弹出窗口以打印预约单");return}t.document.write(`
    <html>
    <head>
      <title>挂号预约单</title>
      <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: SimSun, sans-serif; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        table, th, td { border: 1px solid black; }
        th, td { padding: 8px; text-align: left; }
        .remark { margin-top: 15px; border: 1px solid black; padding: 10px; }
      </style>
    </head>
    <body>
      <h1>${n.hospitalName}</h1>
      <h2 style="text-align:center">挂号预约信息单</h2>
      <table>
        <tr><th>编号</th><td>${n.appointmentId}</td></tr>
        <tr><th>患者姓名</th><td>${n.patientName}</td></tr>
        <tr><th>挂号预约医生</th><td>${n.doctorName}</td></tr>
        <tr><th>医院名称</th><td>${n.hospitalName}</td></tr>
        <tr><th>挂号预约科室</th><td>${n.department}</td></tr>
        <tr><th>挂号预约时间</th><td>${n.createTime}</td></tr>
        <tr><th>挂号预约状态</th><td>${n.isCompleted}</td></tr>
      </table>
      <div class="remark">
        <p><b>病情描述:</b></p>
        <p>${n.remark||"无"}</p>
      </div>
      <p style="text-align:right">打印时间: ${new Date().toLocaleString()}</p>
    </body>
    </html>
  `),t.document.close(),t.onload=()=>{t.print(),setTimeout(()=>t.close(),500)}},j=()=>{w.value=!1,Object.assign(n,{patientName:"",appointmentId:0,hospitalName:"",department:"",doctorName:"",createTime:"",isCompleted:"",remark:""})},N=async()=>{try{const t=await xe(M);if(t){const e=t.map(l=>({appointmentId:l.appointmentId,patientName:l.patientName,hospitalName:l.hospitalName,department:l.department,doctorName:l.doctorName,createTime:E(l.createTime),isCompleted:l.isCompleted?"已完成":"未完成",remark:l.remark}));R.value=e,P.value=e.length}}catch(t){console.error("获取预约列表失败",t)}},ge=()=>{y.value=!0},ve=()=>{b.value=!1},he=async()=>{V.value&&await V.value.validate(t=>{t&&(b.value=!0,y.value=!1)})},_e=async()=>{if(V.value)try{const t=new Date(i.createTime).getTime(),e=await Se(i.patientName,i.doctorName,i.hospitalName,i.department,i.remark,t);e&&e.code===200?(u.success("挂号预约成功"),b.value=!1,N()):u.error("挂号预约失败！")}catch(t){u.error("提交请求失败"),console.error(t)}},be=t=>t.getTime()<Date.now()-864e5,Ne=t=>{const e=new Date;return t.getDate()===e.getDate()&&t.getMonth()===e.getMonth()&&t.getFullYear()===e.getFullYear()?{hours:Array.from({length:e.getHours()},(l,d)=>d),minutes:t.getHours()===e.getHours()?Array.from({length:e.getMinutes()},(l,d)=>d):[]}:{hours:[],minutes:[]}},we=t=>{C.value=t},ye=()=>{if(C.value.length===0){u.warning("请选择要删除的预约");return}const t=C.value.filter(e=>e.isCompleted);if(t.length===0){u.warning("只能删除已完成的预约");return}if($.value){u.warning("正在处理删除请求，请稍候...");return}Q.confirm(`确定要删除选中的 ${t.length} 条已完成的预约记录吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{$.value=!0;const e=[];try{for(const l of t){let d=0;const s=3;for(;d<s;)try{await J(l.appointmentId),await new Promise(v=>setTimeout(v,1e3));break}catch(v){d++,d===s?(console.error(`删除预约 ${l.appointmentId} 失败，已重试${s}次:`,v),e.push(l.appointmentId)):await new Promise(z=>setTimeout(z,2e3))}}e.length===0?u.success("批量删除成功"):u.warning(`部分删除成功，${e.length} 条记录删除失败，请稍后重试`),await new Promise(l=>setTimeout(l,1e3)),N(),C.value=[]}catch(l){u.error("批量删除失败，请稍后重试"),console.error("批量删除失败:",l)}finally{$.value=!1}}).catch(()=>{})};return ze(()=>{N()}),(t,e)=>{const l=g("el-input"),d=g("el-button"),s=g("el-table-column"),v=g("el-tag"),z=g("el-table"),Ce=g("el-pagination"),f=g("el-descriptions-item"),L=g("el-descriptions"),Y=g("el-card"),U=g("el-dialog"),B=g("el-autocomplete"),I=g("el-form-item"),Ie=g("el-date-picker"),ke=g("el-form"),De=Le("loading");return G(),K("div",Me,[qe,p("div",Fe,[p("div",He,[o(l,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=r=>D.value=r),placeholder:"请输入挂号预约编号"},null,8,["modelValue"]),o(d,{type:"primary",onClick:de,class:"search-button"},{default:a(()=>[c("搜索挂号预约")]),_:1}),o(d,{type:"primary",onClick:ge,class:"search-button"},{default:a(()=>[Oe,c(" 我要挂号 ")]),_:1}),o(d,{type:"danger",onClick:ye,class:"search-button",disabled:!C.value.length},{default:a(()=>[Ee,c(" 批量删除 ")]),_:1},8,["disabled"])])]),o(z,{data:R.value,border:"",style:{width:"100%"},onSelectionChange:we},{default:a(()=>[o(s,{type:"selection",width:"55"}),o(s,{prop:"appointmentId",label:"挂号预约编号"}),o(s,{prop:"patientName",label:"患者姓名"}),o(s,{prop:"createTime",label:"挂号预约时间"}),o(s,{prop:"doctorName",label:"医生姓名"}),o(s,{prop:"hospitalName",label:"医院名称"}),o(s,{prop:"department",label:"挂号预约科室"}),o(s,{prop:"isCompleted",label:"挂号预约状态"},{default:a(r=>[o(v,{type:r.row.isCompleted==="已完成"?"success":"warning"},{default:a(()=>[c(m(r.row.isCompleted),1)]),_:2},1032,["type"])]),_:1}),o(s,{prop:"remark",label:"病情描述"}),o(s,{label:"操作",fixed:"right",width:"300"},{default:a(r=>[o(d,{type:"primary",size:"small",onClick:Ve=>me(r.row)},{default:a(()=>[c("挂号预约详情")]),_:2},1032,["onClick"]),o(d,{type:"danger",size:"small",onClick:Ve=>pe(r.row),disabled:r.row.isCompleted==="已完成"},{default:a(()=>[c("取消挂号预约")]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"]),p("div",je,[o(Ce,{"current-page":x.value,"onUpdate:currentPage":e[1]||(e[1]=r=>x.value=r),"page-size":A.value,"onUpdate:pageSize":e[2]||(e[2]=r=>A.value=r),"page-sizes":[10,15,20],total:P.value,layout:"total, sizes, prev, pager, next",onSizeChange:ce,onCurrentChange:ue},null,8,["current-page","page-size","total"])]),o(U,{modelValue:w.value,"onUpdate:modelValue":e[3]||(e[3]=r=>w.value=r),title:"挂号预约详情",width:"50%","before-close":j},{footer:a(()=>[p("span",Ke,[o(d,{onClick:j},{default:a(()=>[c("关闭")]),_:1}),o(d,{type:"primary",onClick:fe},{default:a(()=>[c("打印挂号预约单")]),_:1})])]),default:a(()=>[Ue((G(),K("div",Ye,[p("h2",Je,m(n.hospitalName),1),We,o(L,{column:2,border:""},{default:a(()=>[o(f,{label:"编号"},{default:a(()=>[c(m(n.appointmentId),1)]),_:1}),o(f,{label:"患者姓名"},{default:a(()=>[c(m(n.patientName),1)]),_:1}),o(f,{label:"挂号预约医生"},{default:a(()=>[c(m(n.doctorName),1)]),_:1}),o(f,{label:"医院名称"},{default:a(()=>[c(m(n.hospitalName),1)]),_:1}),o(f,{label:"挂号预约科室"},{default:a(()=>[c(m(n.department),1)]),_:1}),o(f,{label:"挂号预约时间"},{default:a(()=>[c(m(n.createTime),1)]),_:1}),o(f,{label:"挂号预约状态"},{default:a(()=>[c(m(n.isCompleted),1)]),_:1})]),_:1}),o(Y,{class:"record-content"},{default:a(()=>[o(L,{direction:"vertical",column:1,border:""},{default:a(()=>[o(f,{label:"病情描述"},{default:a(()=>[c(m(n.remark),1)]),_:1})]),_:1})]),_:1}),p("div",Ge," 打印时间: "+m(new Date().toLocaleDateString()),1)])),[[De,S.value]])]),_:1},8,["modelValue"]),o(U,{modelValue:y.value,"onUpdate:modelValue":e[10]||(e[10]=r=>y.value=r),title:"挂号预约",width:"60%"},{footer:a(()=>[p("span",et,[o(d,{onClick:e[9]||(e[9]=r=>y.value=!1)},{default:a(()=>[c("取消")]),_:1}),o(d,{type:"primary",onClick:ie},{default:a(()=>[c("确认挂号")]),_:1})])]),default:a(()=>[o(ke,{model:i,rules:ee,ref_key:"formRef",ref:V,"label-width":"120px",class:"form-container"},{default:a(()=>[o(Y,{class:"form-card",shadow:"hover"},{default:a(()=>[p("div",Qe,[o(I,{label:"医院名称：",required:"",prop:"hospitalName"},{default:a(()=>[o(B,{modelValue:i.hospitalName,"onUpdate:modelValue":e[4]||(e[4]=r=>i.hospitalName=r),"fetch-suggestions":te,placeholder:"请输入或选择医院","trigger-on-focus":!0,clearable:"",class:"form-select",onSelect:oe},null,8,["modelValue"])]),_:1}),o(I,{label:"挂号科室：",required:"",prop:"department"},{default:a(()=>[o(B,{modelValue:i.department,"onUpdate:modelValue":e[5]||(e[5]=r=>i.department=r),"fetch-suggestions":ae,placeholder:"请输入或选择科室","trigger-on-focus":!0,clearable:"",class:"form-select",onSelect:le},null,8,["modelValue"])]),_:1}),o(I,{label:"医生姓名：",required:"",prop:"doctorName"},{default:a(()=>[o(B,{modelValue:i.doctorName,"onUpdate:modelValue":e[6]||(e[6]=r=>i.doctorName=r),"fetch-suggestions":ne,placeholder:"请输入医生姓名","trigger-on-focus":!0,clearable:"",class:"form-select",onSelect:se,onFocus:re},null,8,["modelValue"])]),_:1})]),p("div",Xe,[o(I,{label:"挂号时间：",required:"",prop:"createTime"},{default:a(()=>[o(Ie,{modelValue:i.createTime,"onUpdate:modelValue":e[7]||(e[7]=r=>i.createTime=r),type:"datetime",placeholder:"选择日期时间",class:"form-date-picker","disabled-date":be,"disabled-time":Ne},null,8,["modelValue"])]),_:1})]),p("div",Ze,[o(I,{label:"病情描述：",prop:"remark"},{default:a(()=>[o(l,{modelValue:i.remark,"onUpdate:modelValue":e[8]||(e[8]=r=>i.remark=r),type:"textarea",placeholder:"请输入病情描述（选填）",rows:3,class:"form-textarea"},null,8,["modelValue"])]),_:1})])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(U,{modelValue:b.value,"onUpdate:modelValue":e[12]||(e[12]=r=>b.value=r),title:"挂号预约信息确认",width:"50%","before-close":ve},{footer:a(()=>[p("span",tt,[o(d,{onClick:e[11]||(e[11]=r=>b.value=!1)},{default:a(()=>[c("取消")]),_:1}),o(d,{type:"primary",onClick:_e},{default:a(()=>[c("确认挂号预约")]),_:1})])]),default:a(()=>[o(L,{column:1,border:""},{default:a(()=>[o(f,{label:"病人地址"},{default:a(()=>[c(m(i.patientName),1)]),_:1}),o(f,{label:"医院名称"},{default:a(()=>[c(m(i.hospitalName),1)]),_:1}),o(f,{label:"科室"},{default:a(()=>[c(m(i.department),1)]),_:1}),o(f,{label:"医生"},{default:a(()=>[c(m(i.doctorName),1)]),_:1}),o(f,{label:"挂号预约时间"},{default:a(()=>[c(m(i.createTime),1)]),_:1}),o(f,{label:"病情描述"},{default:a(()=>[c(m(i.remark),1)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}});const rt=Re(ot,[["__scopeId","data-v-073dee0c"]]);export{rt as default};
