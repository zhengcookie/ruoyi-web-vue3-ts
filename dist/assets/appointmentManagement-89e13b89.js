import{b as G,d as A,a as J,m as K,n as Q}from"./medical-c6f0a0f6.js";import{d as W,a as c,r as X,q as Z,b as u,o as ee,k as te,e as y,f as n,w as s,E as i,A as x,g,y as B,p as ae,i as ne,_ as oe}from"./index-01cbf18e.js";const z=w=>(ae("data-v-d7e985f8"),w=w(),ne(),w),le={class:"appointment-management"},se=z(()=>y("h2",{class:"page-title"},"挂号预约",-1)),re={class:"search-section"},ie=z(()=>y("i",{class:"el-icon-delete"},null,-1)),de={class:"pagination"},pe={class:"dialog-footer"},me=W({__name:"appointmentManagement",setup(w){const v=c(!1),U=c("挂号预约详情"),f=c(!0),I=c(1),V=c(10),D=c(0),T=c([]),h=c([]),S=c(!1),a=X({appointmentId:"",patientName:"",patient:"",doctorName:"",doctor:"",hospitalName:"",department:"",remark:"",createTime:0,isCompleted:!1}),C=c(),M=async()=>{if(!C.value){i.error("请输入挂号预约编号");return}try{const e=await J(C.value,parseInt(localStorage.getItem("userId")||"0"));e.code==200?(a.appointmentId=e.appointmentId.toString(),a.patientName=e.patientName,a.doctorName=e.doctorName,a.hospitalName=e.hospitalName,a.department=e.department,a.createTime=e.createTime,a.isCompleted=e.isCompleted,a.remark=e.remark,T.value=[e],v.value=!0):i.error(e.msg)}catch{i.error("搜索失败")}},E=e=>{a.appointmentId=e.appointmentId,a.patient=e.patient,a.doctor=e.doctor,a.patientName=e.patientName,a.appointmentId=e.appointmentId,a.department=e.department,a.hospitalName=e.hospitalName,a.doctorName=e.doctorName,a.createTime=e.createTime,a.isCompleted=e.isCompleted,a.remark=e.remark,a.isCompleted?f.value=!0:f.value=!1,v.value=!0},P=async()=>{try{let e=a.createTime;if(typeof e=="string"&&e.indexOf("T")===-1){const o=new Date(e);isNaN(o.getTime())||(e=o.getTime())}(await K(parseInt(a.appointmentId),a.hospitalName,a.department,a.remark,e)).code===200?i.success("挂号预约保存成功"):i.error("挂号预约保存失败!"),v.value=!1,_()}catch{i.error("保存挂号预约失败")}},O=e=>{V.value=e,_()},F=e=>{I.value=e,_()},R=e=>{x.confirm("确认完成此挂号预约?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=parseInt(e.appointmentId);if(isNaN(t)){i.error("无效的预约ID");return}await Q(t),i.success("预约已完成"),_()}catch(t){console.error("完成预约失败:",t),i.error("操作失败，请稍后重试")}}).catch(()=>{})},q=e=>{if(!e)return"未设置时间";let t;if(typeof e=="number")t=e;else if(typeof e=="string"){const N=parseInt(e);if(!isNaN(N))t=N;else if(t=new Date(e).getTime(),isNaN(t))return"无效时间格式"}else return"无效时间格式";const o=new Date(t),d=o.getFullYear(),r=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0"),b=String(o.getHours()).padStart(2,"0"),k=String(o.getMinutes()).padStart(2,"0"),m=String(o.getSeconds()).padStart(2,"0");return`${d}-${r}-${p} ${b}:${k}:${m}`},H=async e=>{if(!e.isCompleted){i.warning("只能删除已完成的预约");return}x.confirm("确认删除此预约?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=parseInt(e.appointmentId),o=await A(t);o.code===200?(i.success("删除成功"),_()):i.error(o.msg||"删除失败")}catch{i.error("删除失败")}})},_=async()=>{try{const e=await G(parseInt(localStorage.getItem("userId")||"0"));console.log(e);const t=e,o=t.length,d=t.map(r=>{const p=r.createTime||r.time;return console.log("Original appointment time:",p),{...r,createTime:q(p)}});T.value=d,D.value=o}catch{i.error("获取数据失败")}},L=e=>{h.value=e},Y=()=>{if(h.value.length===0){i.warning("请选择要删除的预约");return}const e=h.value.filter(t=>t.isCompleted);if(e.length===0){i.warning("只能删除已完成的预约");return}if(S.value){i.warning("正在处理删除请求，请稍候...");return}x.confirm(`确定要删除选中的 ${e.length} 条已完成的预约记录吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{S.value=!0;const t=[];try{for(const o of e){let d=0;const r=3;for(;d<r;)try{await A(o.appointmentId),await new Promise(p=>setTimeout(p,1e3));break}catch(p){d++,d===r?(console.error(`删除预约 ${o.appointmentId} 失败，已重试${r}次:`,p),t.push(o.appointmentId)):await new Promise(b=>setTimeout(b,2e3))}}t.length===0?i.success("批量删除成功"):i.warning(`部分删除成功，${t.length} 条记录删除失败，请稍后重试`),await new Promise(o=>setTimeout(o,1e3)),_(),h.value=[]}catch(o){i.error("批量删除失败，请稍后重试"),console.error("批量删除失败:",o)}finally{S.value=!1}}).catch(()=>{})};return Z(()=>{_()}),(e,t)=>{const o=u("el-button"),d=u("el-input"),r=u("el-table-column"),p=u("el-tag"),b=u("el-table"),k=u("el-pagination"),m=u("el-descriptions-item"),N=u("el-descriptions"),j=u("el-dialog");return ee(),te("div",le,[se,y("div",re,[n(d,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=l=>C.value=l),placeholder:"请输入挂号预约编号",class:"search-input"},{append:s(()=>[n(o,{type:"primary",onClick:M,class:"search-btn"},{default:s(()=>[g("搜索挂号预约")]),_:1})]),_:1},8,["modelValue"]),n(o,{type:"danger",onClick:Y,class:"search-button",disabled:!h.value.length},{default:s(()=>[ie,g(" 批量删除 ")]),_:1},8,["disabled"])]),n(b,{data:T.value,border:"",style:{"min-width":"100%"},onSelectionChange:L},{default:s(()=>[n(r,{type:"selection",width:"55"}),n(r,{prop:"patientName",label:"患者姓名",width:"120"}),n(r,{fixed:"",prop:"appointmentId",label:"挂号预约编号",width:"120"}),n(r,{prop:"hospitalName",label:"医院名称",width:"120"}),n(r,{prop:"department",label:"科室",width:"120"}),n(r,{prop:"doctorName",label:"医生姓名",width:"120"}),n(r,{prop:"remark",label:"备注",width:"120"}),n(r,{prop:"createTime",label:"挂号预约时间",width:"120"}),n(r,{prop:"isCompleted",label:"挂号预约状态"},{default:s(l=>[n(p,{type:l.row.isCompleted?"success":"warning"},{default:s(()=>[g(B(l.row.isCompleted?"已完成":"未完成"),1)]),_:2},1032,["type"])]),_:1}),n(r,{label:"操作",width:"200"},{default:s(l=>[n(o,{type:"primary",size:"small",onClick:$=>R(l.row)},{default:s(()=>[g("完成")]),_:2},1032,["onClick"]),n(o,{type:"info",size:"small",onClick:$=>E(l.row)},{default:s(()=>[g("编辑")]),_:2},1032,["onClick"]),n(o,{type:"danger",size:"small",onClick:$=>H(l.row),disabled:!l.row.isCompleted},{default:s(()=>[g("删除")]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"]),y("div",de,[n(k,{"current-page":I.value,"onUpdate:currentPage":t[1]||(t[1]=l=>I.value=l),"page-size":V.value,"onUpdate:pageSize":t[2]||(t[2]=l=>V.value=l),"page-sizes":[10,20,30,50],total:D.value,layout:"total, sizes, prev, pager, next",onSizeChange:O,onCurrentChange:F},null,8,["current-page","page-size","total"])]),n(j,{modelValue:v.value,"onUpdate:modelValue":t[11]||(t[11]=l=>v.value=l),title:U.value,width:"50%"},{footer:s(()=>[y("span",pe,[n(o,{onClick:t[10]||(t[10]=l=>v.value=!1)},{default:s(()=>[g("关闭")]),_:1}),n(o,{type:"primary",onClick:P},{default:s(()=>[g("保存")]),_:1})])]),default:s(()=>[n(N,{column:2,border:""},{default:s(()=>[n(m,{label:"挂号预约编号"},{default:s(()=>[n(d,{modelValue:a.appointmentId,"onUpdate:modelValue":t[3]||(t[3]=l=>a.appointmentId=l),disabled:!0},null,8,["modelValue"])]),_:1}),n(m,{label:"患者姓名"},{default:s(()=>[n(d,{modelValue:a.patientName,"onUpdate:modelValue":t[4]||(t[4]=l=>a.patientName=l),disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),n(m,{label:"医生姓名"},{default:s(()=>[n(d,{modelValue:a.doctorName,"onUpdate:modelValue":t[5]||(t[5]=l=>a.doctorName=l),disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),n(m,{label:"医院名称"},{default:s(()=>[n(d,{modelValue:a.hospitalName,"onUpdate:modelValue":t[6]||(t[6]=l=>a.hospitalName=l),disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),n(m,{label:"挂号预约科室"},{default:s(()=>[n(d,{modelValue:a.department,"onUpdate:modelValue":t[7]||(t[7]=l=>a.department=l),disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),n(m,{label:"挂号预约时间"},{default:s(()=>[n(d,{modelValue:a.createTime,"onUpdate:modelValue":t[8]||(t[8]=l=>a.createTime=l),disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),n(m,{label:"状态"},{default:s(()=>[g(B(a.isCompleted?"已完成":"未完成"),1)]),_:1}),n(m,{label:"备注",span:2},{default:s(()=>[n(d,{modelValue:a.remark,"onUpdate:modelValue":t[9]||(t[9]=l=>a.remark=l),type:"textarea",rows:3,disabled:f.value},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}});const ge=oe(me,[["__scopeId","data-v-d7e985f8"]]);export{ge as default};
